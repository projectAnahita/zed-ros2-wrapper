ARG UBUNTU_MAJOR=22
ARG UBUNTU_MINOR=04
ARG CUDA_MAJOR=12
ARG CUDA_MINOR=1
ARG CUDA_PATCH=0

ARG IMAGE_NAME=nvcr.io/nvidia/cuda:${CUDA_MAJOR}.${CUDA_MINOR}.${CUDA_PATCH}-devel-ubuntu${UBUNTU_MAJOR}.${UBUNTU_MINOR}

FROM ${IMAGE_NAME}

# Re-declare ARGs after FROM
ARG UBUNTU_MAJOR
ARG UBUNTU_MINOR
ARG CUDA_MAJOR
ARG CUDA_MINOR
ARG CUDA_PATCH
ARG ROS2_DIST=humble

# Environment setup
ENV DEBIAN_FRONTEND=noninteractive
ENV TZ=America/Los_Angeles
ENV ROS_DISTRO=${ROS2_DIST}
ENV NVIDIA_DRIVER_CAPABILITIES=${NVIDIA_DRIVER_CAPABILITIES:+$NVIDIA_DRIVER_CAPABILITIES,}compute,video,utility

# Install all system dependencies, ROS2 repository, and packages in one layer
RUN apt-get update && apt-get install -y --no-install-recommends \
    # System dependencies
    apt-utils \
    bash-completion \
    build-essential \
    cmake \
    curl \
    dialog \
    git \
    jq \
    less \
    libegl1-mesa \
    libgl1-mesa-glx \
    libpq-dev \
    locales \
    lsb-release \
    micro \
    xclip \
    python3-dev \
    python3-pip \
    python3-venv \
    python3-wheel \
    software-properties-common \
    sudo \
    udev \
    usbutils \
    wget \
    zstd \
    # Node.js dependencies
    ca-certificates \
    gnupg \
    # Audio dependencies
    alsa-utils \
    ffmpeg \
    pavucontrol \
    portaudio19-dev \
    pulseaudio \
    pulseaudio-utils \
    && locale-gen en_US en_US.UTF-8 \
    && update-locale LC_ALL=en_US.UTF-8 LANG=en_US.UTF-8 \
    && ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && echo $TZ > /etc/timezone \
    # Setup Node.js repository
    && mkdir -p /etc/apt/keyrings \
    && curl -fsSL https://deb.nodesource.com/gpgkey/nodesource-repo.gpg.key | gpg --dearmor -o /etc/apt/keyrings/nodesource.gpg \
    && echo "deb [signed-by=/etc/apt/keyrings/nodesource.gpg] https://deb.nodesource.com/node_20.x nodistro main" | tee /etc/apt/sources.list.d/nodesource.list \
    # Install CUDA keyring and cuDNN
    && wget https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2204/x86_64/cuda-keyring_1.1-1_all.deb \
    && dpkg -i cuda-keyring_1.1-1_all.deb \
    && rm -f cuda-keyring_1.1-1_all.deb \
    # After adding new repositories, update and install additional packages
    && apt-get update \
    && apt-get install -y nodejs cudnn-cuda-12 \
    # Set up ROS2 repository
    && add-apt-repository universe \
    && curl -sSL https://raw.githubusercontent.com/ros/rosdistro/master/ros.key -o /usr/share/keyrings/ros-archive-keyring.gpg \
    && echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/ros-archive-keyring.gpg] http://packages.ros.org/ros2/ubuntu $(. /etc/os-release && echo $UBUNTU_CODENAME) main" | tee /etc/apt/sources.list.d/ros2.list > /dev/null \
    # After adding ROS2 repository, update and install ROS2 packages
    && apt-get update \
    && apt-get install -y --no-install-recommends \
    ros-${ROS_DISTRO}-ros-base \
    ros-${ROS_DISTRO}-ament-cmake-auto \
    ros-${ROS_DISTRO}-ament-cmake-clang-format \
    ros-${ROS_DISTRO}-diagnostic-updater \
    ros-${ROS_DISTRO}-image-transport \
    ros-${ROS_DISTRO}-image-transport-plugins \
    ros-${ROS_DISTRO}-joint-state-publisher \
    ros-${ROS_DISTRO}-joint-state-publisher-gui \
    ros-${ROS_DISTRO}-moveit \
    ros-${ROS_DISTRO}-moveit-common \
    ros-${ROS_DISTRO}-moveit-ros-planning \
    ros-${ROS_DISTRO}-moveit-ros-planning-interface \
    ros-${ROS_DISTRO}-moveit-visual-tools \
    ros-${ROS_DISTRO}-rmw-cyclonedds-cpp \
    ros-${ROS_DISTRO}-rmw-fastrtps-cpp \
    ros-${ROS_DISTRO}-robot-state-publisher \
    ros-${ROS_DISTRO}-ros2cli \
    ros-${ROS_DISTRO}-rviz-visual-tools \
    ros-${ROS_DISTRO}-xacro \
    ros-dev-tools \
    && rosdep init \
    && rosdep update \
    # Clean up
    && rm -rf /var/lib/apt/lists/*

# Stay as root for consistent ownership
WORKDIR /root/workspace/ws_startup/artifex

# Set up Python virtual environment and install packages
RUN python3 -m venv /opt/venv && \
    . /opt/venv/bin/activate && \
    pip install --upgrade pip && \
    # Install PyTorch packages first with CUDA support
    pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu121 && \
    # Install the rest of the packages from PyPI
    pip install \
        typeguard \
        'numpy<2' \
        argcomplete \
        black \
        catkin_pkg \
        colcon-common-extensions \
        colcon-mixin \
        cython \
        empy==3.3.4 \
        flake8-blind-except \
        flake8-builtins \
        flake8-class-newline \
        flake8-comprehensions \
        flake8-deprecated \
        flake8-docstrings \
        flake8-import-order \
        flake8-quotes \
        imageio \
        lark-parser \
        matplotlib \
        mediapipe \
        mypy \
        opencv-python \
        opencv-python-headless \
        openai \
        pandas \
        pyaudio \
        pydub \
        pyloudnorm \
        pyopengl \
        pyqt5 \
        pvporcupine \
        pytest \
        pytest-cov \
        pytest-repeat \
        pytest-rerunfailures \
        requests \
        resampy \
        scikit-learn \
        scipy \
        sounddevice \
        vcstool \
        webrtcvad \
        nvidia-ml-py3 \
        pytest-asyncio \
        python-dotenv \
        faster-whisper \
        transformers \
        elevenlabs \
        'accelerate>=0.26.0' \
        'spacy==3.8.4' \
    && python -m spacy download en_core_web_lg \
    && rm -rf /root/.cache/pip

# Setup shell environment
COPY .bashrc /root/.bashrc
COPY .bash_aliases /root/.bash_aliases

# Set final working directory
WORKDIR /root/workspace/ws_startup

# Final setup
COPY ros_entrypoint_desktop.sh /sbin/ros_entrypoint.sh
RUN chmod 755 /sbin/ros_entrypoint.sh && \
    mkdir -p /root/.config/pulse

ENTRYPOINT ["/sbin/ros_entrypoint.sh"]
CMD ["bash"]